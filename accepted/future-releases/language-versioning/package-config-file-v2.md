# Dart Package Configuration File v2.0

Author: lrn@google.com
Version: 0.2

Dart currently uses a `.packages` file to configure *package URI resolution* (converting a package URI to a file name). The file uses a `.ini` file-like format with package names as keys and URI references as values. The URI references generated by Pub are always absolute or relative paths, so third-party users of the file tend to see them as paths, not URI.

For the *language versioning* feature, we have proposed extending the format by adding fragments to the URI references and an entry with the empty string as key. This is a breaking change (the empty key was not previously accepted) and even more breaking for tools which assume the values are paths.

Instead of breaking the existing file users, we will instead introduce a *new* file containing the information that we intended to store in the `.packages` file. This fill will use a (more) structured format which allows extending it with further information in the future. We will still generate the `.packages` file for now, allowing users of the file to continue working until they can migrate to using the new file.

## New File

### Syntax

The new file format should be extensible and efficiently parsable in languages other than Dart. It should be possible to check the file into a source versioning system if you want to, so a text based format is preferred. We want something structured, text-based and widely supported.

We choose JSON. JSON is *not* easy to write by hand (but doable), and it does not allow comments, but this is a machine generated file that will hardly ever be edited by hand.

The primary way for users to create the file is by running the Pub tool. That tool is free to overwrite an existing file, and Pub may be invoked automatically by editors, so any manually added changes are likely lost. There is no support for manual edits surviving across generation of a new file. 

Some users may use other tools than Pub to control their package resolution. Those tools need to also support the new format.

### Location

The new file will be stored by Pub in the `.dart_tool` directory. It is a file used and shared by various Dart tools, so this location is sensible and consistent. It avoids clutter at the top-level of a package, and the `.dart_tool` directory is already in `.gitignore` files.

Tools which needs the file will automatically look for it in `.dart_tool` subdirectories of the directories where they would currently look for `.package` files.

### Name

The new file's name should signal three things: 

- It is a generated file, not intended for manual editing.
- It is used by the Dart language tools to understand Dart source correctly.
- It's JSON, so in case you do want to view or edit the file, the editor can treat it properly.

Naming is still open. One option is "dart_config.json".

### Contents

The file will contain the information that was planned for the `.packages` file:

- A *default package* specified by its package name.
- A list of *packages*, each with:
  - A *package name*.
  - A *path* or *location URI*.
  - A *language version* (major/minor version number).

On top of that, we also add extra metadata which allows us to version the format and attach information about when and how the file was created.

The format is JSON text describing is a JSON object.

That object has, at least, the following properties:

- `apiVersion`: A single integer marking the version of this format, currently `2` (counting `.packages` as the first). Tools should refuse to work on files with a larger version number than the ones they are aware of. Incremental changes will not require increasing the version, so new versions are not expected any time soon, but code should still prepare for it.

- `defaultPackage`: A string containing a package name.
- `packages`: A list of packages, each with the following properties:
  - `name`: A string containing a package name.
  - either `path`: A string containing a relative or absolute path using `/` as separator. Every character other than `/` is used verbatim. If the path starts with a `/` or with a DOS/Windows drive letter (a single letter followed by `:/`), then it is considered absolute. If not, the path is relative to the directory of the `.packages.json` file. 
  - or `uri`: A URI reference. This is resolved relative to the (likely `file:`) URI referencing the `.package.json` file. If the URI reference has no scheme, or if it has a `file:` scheme, it is recommended to use the `path` instead. (If we do not need non-`file:` locations, then we should only allow `path`. Do we need them?)
  - `languageVersion`: Optional. A string containing a language version (major.minor).

Tools should ignore properties that they don't recognize. This will allow us to add more properties in the future without increasing the `apiVersion` number, but not to remove properties or change the meaning of existing properties. 

If we remove a property that tools rely on, change the meaning of an existing property, or add more information that is *required* for resolving and understanding Dart source files, it is a breaking change&mdash;tools expecting the previously available data will no longer understand the whole picture. Such changes will require increasing the `apiVersion` number.

The following properties allows the generator to specify metadata about the file:

- `generated`: A string containing an ISO-8601 UTC timestamp for when the file was generated, using the format: `YYYY-MM-DDTHH:mm:ss.sssZ`.
- `generator`: An object containing at last the following properties:
  - `name`: Name/identifier of the generator. Likely `pub`.
  - `version`: The version of the generator. A [Semantic Version](https://semver.org/spec/v2.0.0-rc.1.html. Pub can probably use the SDK version.

These are all optional, but if they are present, they should have the expected format.

The JSON properties may occur in any order, except that the `apiVersion` *must* be the first entry in the file. The Dart JSON serializer uses iteration order of the incoming map, so controlling the order is possible. The file *should* be "pretty printed" with newlines and indentation, to make human inspection easier.

If a tool wants to store extra information in the `.packages.json` file, they can do so under a key prefixed by `toolname:`, so if Pub wanted to store more information on a package, say the package version, it could do so as `"pub:pkgVersion": "1.16.0"` in the package entry. Keys containing `:` are reserved for custom tool-specific properties. This feature can only really be used by the tool generating the file (as a generated file, it may be overwritten at any time), and it should be used sparingly since unknown properties are just overhead for all other users of the file. Still, if a tool can cooperate with Pub and provide the information in `pubspec.yaml`, Pub might be able to put it into the configuration file as well.

#### Package Names

Some properties are specified as being "package names".

A package name is used as both a URI path segment and a directory name. To ensure this is possible, we define a package name as a string containing:

- Only [URI path characters](https://www.ietf.org/rfc/rfc3986.txt) (RFC 3986 "pchar"),
- but no `:` or `%`,
- and containing at least one non-`.` character.

This allows the characters: `a`-`z`, `A`-`Z`, `0`-`9`, `-`, `.`, `_`, `~`, `!`, `$`, `&`, `'`, `(`, `)`, `*`, `+`, `,`, `;`, `=`, `@`. 
It avoids the characters `/`, `\` and `:` which are meaningful in paths on various operating systems, as well as the strings `.` and `..`, and it ensures that the package name is a valid non-empty URI path segment.

Pub has stronger restrictions on its accepted package names, but this file will also be used in settings where packages are not supplied by Pub.

### Finding the File

When compiling a Dart script file, the Dart tool will look for the necessary information starting in the directory of the script file. It will first check for a `.dart_tool/dart_config.json` file, then for a `.packages` file, the it will repeat this through the parent directories until it one such file or it reaches the file system root.

The analyzer needs to cleverly determine which configuration file applies to which file, based on the location of scripts, which scripts may transitively import a file, and understanding of the structure of Pub packages.. It should be able to use the same algorithm as now, just that where it currently looks for a `.packages` in a directory, it will have to for `.dart_tool/dart_config.json` first.

### Specifying the File

Tools currently allow you to specify the `.packages` file with a command line argument:

```
--packages=someFile
-p someFile
```

This approach will work with the JSON configuration file as well. The tool must scan the file to detect whether it is a JSON file or an original `.packages` file. It is considered a JSON file if the first non-whitespace (space, tab, carriage return, linefeed) character is a `{`. The JSON file must start this way, and the existing format cannot do so; it must start with either a comment, `#`, or a non-empty package name, and package names cannot contain a `{` character.

## Possible Extensions

We can consider already adding more features to the format. These features should be ones that are of relevance to compilers reading source files, since that is the goal of the file.

Any such extensions would need to be added by the generator, so in practice they must come from `pubspec.yaml` to begin with. If the Pub tool wants to support these, it is possible. 

### Experiments

Maybe you can enable experiments for a specific package by adding, for example:

```json
"experiments": ["non-nullable"]
```

to a single package entry, or add it in the outer object to enable it for all compatible packages.

### Environment Variables

Maybe you can hard-code some environment variables by adding, for example:

```json
"environment": {
  "myFlag": "true",
  "logLevel": "verbose"
}
```

in the outer object. These would be available for `String.fromEnvironment("logLevel", defaultValue: "default")` or `bool.fromEnvironment("myFlag")`

## Summary

A file,  perhaps named `dart_config.json`, stored in `.dart_tool` will coexist with `.packages` until `.packages` can be phased out.

The format will look like:

```json
{
  "apiVersion": 2,
  "defaultPackage": "myPackage",
  "packages": [
    {
      "name": "myPackage",
      "path": "lib/",
      "languageVersion": "2.6"
    },
    {
      "name": "myHelperPackage",
      "path": "../myHelperPackage/lib/",
      "languageVersion": "2.5"
    },
    {
      "name": "test",
      "path": "/users/myself/.pubcache/test-1.16.0/lib/",
      "languageVersion": "2.5"
    },
    ... 
  ],
  "generated": "2019-09-12T12:13:14",
  "generator": {
    "name": "pub",
    "version": "2.6.0-dev.0.2"
  }
}
```
